[tools]
go = "1.25"
"go:github.com/golangci/golangci-lint/cmd/golangci-lint" = "latest"
"go:golang.org/x/vuln/cmd/govulncheck" = "latest"

[env]
CGO_ENABLED = "0"

[tasks.build]
description = "Build the MCP server binary"
run = "go build -o bin/obx ./cmd/obx"

[tasks.dev]
description = "Build and run with test vault"
run = "go run ./cmd/obx ../vault"

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run ./..."

[tasks.test]
description = "Run tests with race detection"
run = "go test -race -cover ./..."

[tasks.fuzz]
description = "Run all fuzz tests (10s each)"
run = """
for fuzz in ParseTask ExtractTags ExtractWikilinks ExtractH1Title Truncate IsMOC; do
  echo "=== Fuzzing $fuzz ==="
  go test -fuzz=Fuzz$fuzz -fuzztime=10s ./internal/vault/...
done
"""

[tasks."fuzz:one"]
description = "Run a single fuzz test (FUZZ_NAME=ParseTask FUZZ_TIME=30s)"
run = "go test -fuzz=Fuzz${FUZZ_NAME:-ParseTask} -fuzztime=${FUZZ_TIME:-30s} ./internal/vault/..."

[tasks.vuln]
description = "Check for vulnerabilities"
run = "govulncheck ./..."

[tasks.install]
description = "Build and install obx to ~/.local/bin"
run = "./install.sh"

[tasks.link]
description = "Fast rebuild directly to ~/.local/bin/obx for rapid iteration"
run = "go build -ldflags='-s -w' -o ~/.local/bin/obx ./cmd/obx"

[tasks.check]
description = "Run all checks (lint + test + vuln)"
depends = ["lint", "test", "vuln"]

[tasks.fmt]
description = "Format code"
run = "gofmt -w ."

[tasks."docs:dev"]
description = "Run docs dev server"
dir = "docs"
run = "pnpm dev"

[tasks."docs:build"]
description = "Build docs for production"
dir = "docs"
run = "pnpm build"

[tasks."docs:preview"]
description = "Preview production docs build"
dir = "docs"
run = "pnpm preview"

[tasks."docs:install"]
description = "Install docs dependencies"
dir = "docs"
run = "pnpm install"
